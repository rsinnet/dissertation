\section{Energy Shaping}
\showtoc

\subsection{Energy Shaping with Control Lyapunov Functions}

\begin{frame}[t]
  \frametitle{Motivation}
  \begin{block}{Main Question}
    Can we use an understanding of energy exchange to improve robustness  of
    periodic orbits in hybrid mechanical systems?
  \end{block}

  \begin{block}{Observations}
    \begin{itemize}
    \item Numerous control design schemes exist for stabilizing hybrid mechanical
      systems to periodic orbits.
    \item Some controllers produce good behavior locally but lack robustness.
    \item Periodic orbits have associated energy functions with level sets which
      are invariant under the orbits.
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}[t]
  \frametitle{Conserved Energy Functions}
  \only<1> {
    \begin{block}{Conservative Systems}
      A conservative system with state space $\x = \argsqdq$ is modeled as
      \begin{align*}
        \HCSbar = \left\{
          \begin{array}{r c l l}
            \dx &=& \xfbar\argsqdq + \xgbar\argsq \, \uu, & \argsqdq \in \D \setminus \S,\\
            \xp &=& \Delta(\xm), & \argsqdq \in \S.
          \end{array}\right.
      \end{align*}
      where $\xfbar\argsqdq = \xf\argsqdq$ and $\xgbar\argsq = \xg\argsq$ for notational clarity. Total
      energy is conserved through the continuous dynamics, i.e.,
      \begin{align*}
        \Ec\argsqdq = T\argsqdq + U\argsq.
      \end{align*}
    \end{block}
  }

  \only<2> {
    \begin{block}{Nonconservative Systems}
      To properly handle the flow of energy from $\vv\argsqdq$, define a storage
      function, $\W$, which obeys the differential equation
      \begin{align*}
        d\W = \vfR\argsqdq \, dt = \left( \B\argsq \, \vv\argsqdq \right)^{T}
        \frac{d\q}{dt}\art \, dt.
      \end{align*}
      Using $\W$, augment the state space, $\x := (\q, \dq, \W)$, and the vector
      fields,
      \begin{align*}
        \xfbar\argsqdq := \left(\begin{array}{c}
            \xf\argsqdq\\
            \vfR\argsqdq
          \end{array}\right), &&
        \xgbar\argsq := \left(\begin{array}{c}
            \xg\argsq\\
            \boldzero
          \end{array}\right).
      \end{align*}
    \end{block}
  }
  \only<3> {
    \begin{block}{Nonconservative Systems}
      Use the augmented state to define the hybrid control system
      \begin{align*}
        \HCSbar = \left\{
          \begin{array}{l l}
            \left.\begin{array}{r c l}
                \hspace{1.15em}\dx &=& \xfbar\argsqdq + \xgbar\argsq \, \uu
              \end{array}\right\}  & \mbox{if } \argsqdq \in \D \setminus \S,\\
            \left. \begin{array}{r c l}
                \qp &=& \Deltaq\argsqm\\
                \dqp &=& \Deltadq\argsqdqm\\
                \Wp &=& 0
              \end{array} \right\} & \mbox{if } \argsqdq \in \S.
          \end{array}\right.
      \end{align*}
      For such a system, the following quantity is conserved:
      \begin{align*}
        \Ec\argsqdqW = T\argsqdq + U\argsq - W
      \end{align*}
    \end{block}
  }
\end{frame}

\begin{frame}[t]
  \frametitle{Setup}
  \only<1>{
    \begin{block}{Conservative Systems}
      Consider the hybrid control system
      \begin{align*}
        \HCS = \left\{
          \begin{array}{r c l l}
            \dx &=& \xf\arx + \xg\arx \, \uu, & \x \in \D \setminus \S,\\
            \xp &=& \Delta(\xm), & \x \in \S.
          \end{array}\right.
      \end{align*}
      For a \blue{conservative system}, $\uu \equiv \boldzero$. For simplicity
      of exposition when dealing with conservative systems, define $\xfbar\arx =
      \xf\arx$ and
      \begin{align*}
        \HCSbar = \left\{
          \begin{array}{r c l l}
            \dx &=& \xfbar\arx + \xg\arx \, \uu, & \x \in \D \setminus \S,\\
            \xp &=& \Delta(\xm), & \x \in \S.
          \end{array}\right.
      \end{align*}
    \end{block}
  }
  
  \only<2>{
    \begin{block}{Nonconservative Systems}
      Consider the hybrid control system
      \begin{align*}
        \HCS = \left\{
          \begin{array}{l l}
            \dx = \xf\arx + \xg\arx \, \uu, & \x \in \D \setminus \S,\\
            \xp = \Delta(\xm), & \x \in \S.
          \end{array}\right.
      \end{align*}
      For a \blue{nonconservative system}, assume the nominal  control input
      $\uu$ takes the form of a feedback control law, $\vv : \X \to \R^{n}$
      which is subsumed under the vector field $\xfbar\arx = \xf\arx + \xg\arx \,
      \vv\arx$ yielding
      % and augment the
      % state space with a \blue{storage function}, $W$:      
      \begin{align*}
        \HCSbar = \left\{
          \begin{array}{l l}
            \dx = \xfbar\arx + \xg\arx \, \uu, & \x \in \D \setminus \S,\\
            \xp = \Delta(\xm), & \x \in \S.
          \end{array}\right.
      \end{align*}      
    \end{block}
  }
    
  \only<3>{
    \begin{block}{Main Idea}
      Add robustness to a periodic behavior by imposing convergence on an energy
      function to a level set which is known to be invariant under the system dynamics.
    \end{block}
    
    \begin{block}{Control Objective}
      Choose control input $\mu\arx$ such that $\| \mu\arx \|$ is minimized and $\Ec\arxt \to \Eref$ as $t \to \infty$.
    \end{block}

    \begin{block}{Exponential Convergence}
      To achieve exponential stabilization, $\Ec\arxt$ should satisfy\vspace{-.4em}
      \begin{align*}
        \Ec\arxt \leq \Ec\arxzero e^{-\beta t} \mbox{ for } t \geq 0, \beta > 0.
      \end{align*}
    \end{block}
  }
\end{frame}

\begin{frame}[t]
  \frametitle{Rapidly Exponentially Stabilizing CLFs}
  A \blue{rapidly exponentially stability control Lyapunov function (RES--CLF)}
  $\Ve : \X \to \Rnn$ satisfies
  \begin{align*}
    &c_{1} \nx^{2} \leq \Ve\arx \leq \frac{c_{2}}{\resclfparam^{2}} \nx^{2},\\
    &\inf_{\uu \in \U} \Lie{\xfbar}\Ve\arx + \Lie{\xg}\Ve\arx \, \uu +
    \frac{c_{3}}{\resclfparam} \Ve\arx \leq 0
  \end{align*}
  for $c_{1}, c_{2}, c_{3} > 0$ exhibits exponential convergence. If the above
  are satisfied, then it is also true that
  \begin{align*}
    \left\| \pd{\Ve\arx}{\x} \right\| \leq c_{4} \nx.
  \end{align*}
\end{frame}

\begin{frame}[t]
  \frametitle{Energy Shaping}
  \only<1>{
    \begin{block}{Conservative Systems}
      Consider a conserved energy function $\Ec\arx$ on a hybrid control system
      $\HCSbar$ which has a periodic orbit $\orbit$ and define a Lyapunov candidate:
      \begin{align*}
        V\arx = \frac{1}{2} \left(\Ec\arx - \Eref\right)^{2},
      \end{align*}
      with $\Eref$ the constant energy level of the system on the orbit
      $\orbit$. For a RES--CLF, we seek a feedback control law, $\mu\arx$, such that
      \begin{align*}
        \Lie{\xfbar} V\arx + \Lie{\xg} \V\arx \, \mu\arx + \epsilon \V\arx &\leq 0.
      \end{align*}
    \end{block}
  }
  
  \only<2>{
    \begin{block}{Nonconservative Systems}
      Consider a conserved energy function $\Ec\arxW$ on a hybrid control system
      $\HCSbar$ which has a periodic orbit $\orbit$ and define a Lyapunov candidate:
      \begin{align*}
        V\arxW = \frac{1}{2} \left(\Ec\arxW - \Eref\right)^{2},
      \end{align*}
      with $\Eref$ the constant energy level of the system on the orbit
      $\orbit$. For a RES--CLF, we seek a feedback control law, $\mu\arxW$, such that
      \begin{align*}
        \Lie{(\xfbar, \vfR)} V\arxW + \Lie{(\xg, \boldzero)} \V\arxW \, \mu\arxW + \epsilon \V\arxW &\leq 0.
      \end{align*}
    \end{block}
  }
\end{frame}

\begin{frame}[t]
  \frametitle{Quadratic Program Formulation}
  The linear form of the RES--CLF condition suggests
  \begin{align}
    \nonumber
    \mueps\arx = \argmin_{\uu \in \R^{n}}  \, & \uu^T \uu,\\
    \mbox{s.t. } & \Aclf\arx \, \uu \leq \bclf\arx
  \end{align}
  which encodes the dynamics of the system. This controller imposes exponential
  stabilization of the energy as defined by the RES--CLF.
\end{frame}

\begin{frame}[t]
  \frametitle{Main Theorem}
  \only<1> {
    \begin{block}{Theorem [Energy Shaping (Conservative Systems)]}
      Given an exponentially-stable cycle in a hybrid system, application
      of the energy shaping controller results in the closed-loop hybrid system
      \begin{align*}
        \HS_{\resclfparam} = \left\{
          \begin{array}{r c l l}
            \dx &=& \xfbar\arx + \xg\arx \, \mueps\arx, & \x \in \D \setminus \S,\\
            \xp &=& \Delta(\xm), & \x \in \S,
          \end{array}\right.
      \end{align*}
      which is exponentially stable about the hybrid periodic orbit $\orbit$ for
      large enough $\resclfparam$.
    \end{block}
  }
  
  \only<2> {
    \begin{block}{Theorem [Energy Shaping (Nonconservative Systems)]}
      Given an exponentially-stable cycle in a hybrid system, application
      of the energy shaping controller results in the closed-loop hybrid system
      \begin{align*}
        \HS_{\resclfparam} = \left\{
          \begin{array}{l l}
            \begin{array}{r c l}
              \pspace\dx &=& \xfbar\arx + \xg\arx \, \mueps\arxW\\
              \pspace\Wdot &=& \vfR\arx
            \end{array}  & \mbox{if } \x \in \D \setminus \S,\\
            \begin{array}{r c l}
              \xp &=& \Delta(\xm)\\
              \Wp &=& 0
            \end{array} & \mbox{if } \x \in \S.
          \end{array}\right.
      \end{align*}
      which is exponentially stable about the hybrid periodic orbit $\orbit$ for
      large enough $\resclfparam$.
    \end{block}
  }
\end{frame}

\subsection{Sketch of Proof}

\begin{frame}[t]
  \frametitle{Zero Dynamics Formulation}
  Construct a change of coordinates, splitting up the system into two sets of coordinates:
  \begin{align*}
    \dot \zdx &= f\argsxz + g\argsxz \, \uu,\\
    \dot \zdz &= q\argsxz + w\argsxz \, \uu.
  \end{align*}
  The vector fields $f$, $g$, $q$, and $w$ are assumed to be locally Lipschitz
  continuous. For simplicity, define
  \begin{align*}
    \bigF\argsxz = \left(\begin{array}{c}
        f\argsxz\\
        q\argsxz
      \end{array}\right),&&
    \bigG \argsxz = \left(\begin{array}{c}
        g\argsxz\\
        w\argsxz
      \end{array}\right).
  \end{align*}
\end{frame}

\begin{frame}[t]
  \frametitle{Energy-Based Coordinate Change}
  For mechanical systems with coordinates $\x = \argsqdq \in T\Q$, construct the transformation $\xform\argsqdq := \argsxz$ where
  \begin{align*}
    \zdx &= \Ec\argsqdq - \Eref,\\
    \zdz &= \xrem,
  \end{align*}
  where $n$ is the size of the configuration space, $\Q$. The fixed point of the
  hybrid system is chosen to occur at $\argsxz = \xzst$ such that $\Delta\xzst =
  \argszero$.
\end{frame}

\begin{frame}[t]
  \frametitle{Validity of Transformation}
  The coordinate change $\xform\argsqdq$ is valid if it is locally diffeomorphic around the orbit
  $\orbit$, i.e., if
  \begin{align}
    \pd{\xform(\q, \dq)}{(\q, \dq)} =
    \left(\begin{array}{c c}
        I_{2n-1} & \boldzero_{2n-1 \times 1}\\
        \pd{E(\q, \dq)}{\xrem} & \pd{E(\q, \dq)}{\dq_{n}}
      \end{array}\right)
  \end{align}
  % 
  has full rank, which occurs when
  \begin{align*}
    \det\left(\pd{\xform\argsqdq}{\argsqdq}\right) = \pd{E(\q, \dq)}{\dq_{n}} \ne 0.
  \end{align*}
\end{frame}

\begin{frame}[t]
  \frametitle{Flows of Continuous Dynamical Systems}
  Recall that the flow of an ODE expressed in the variables $\argsxz$ is given
  by
  \begin{align*}
    \flowt\argsxz = \int_{0}^{t} \left[ \bigF\argsxztau + \bigG\argsxztau \,
      \uu\argsxztau \right] \, d\tau
  \end{align*}
  for some feedback control law $\uu : \zdX \times \zdZ \to \U$. For some stable
  tube $\stabletube$ around the orbit $\orbit$, it holds that the vector fields are bounded:
  \begin{align*}
    \supF & := \sup \left\{ \left\| \bigF\argsxz \right\| : \argsxz \in
      \stabletube \right\},\\
    \lambdamaxG &:= \sup \left\{\lambdamax\bigG\argsxz : \argsxz \in \stabletube
    \right\},\\
    \lambdaminG &:= \inf \left\{\lambdamin\bigG\argsxz : \argsxz \in \stabletube
    \right\}.
  \end{align*}
\end{frame}


\begin{frame}[t]
  \frametitle{Definition of the \Poincare{} map}
  \only<1> {
    The \blue{\Poincare{} first return map} takes a point on the guard, applies
    the reset map and then integrates forward until the guard is reached
    again. For the shaped system, $\Pe : \S \to \S$, is defined by
    \begin{align*}
      \Pe\argsxz = \floweps_{\TIeDelta}\argsDeltaxz,
    \end{align*}
    where $\TIe : \zdX \times \zdZ \to \Rnn$ is the \tti{} function which is
    defined by
    \begin{align*}
      \TIe\argsxz = \inf \{ t \geq 0 : h(\flowepst\argsxz) \}
    \end{align*}
    and is locally Lipschitz continuous by the implicit function theorem.
  }

  \only<2> {
    \begin{figure}    
      \centering
      \def\svgwidth{.78\columnwidth}
      \input{../figs/poincare_return_map.eps_latex}
      \caption{The \Poincare{} map is defined by the \tti{} function and maps
        from states on the \Poincare{} section $\S$ back to the section.}
    \end{figure}
  }
\end{frame}

% \subsection{Sketch of Proof}

\begin{frame}[t]
  \frametitle{Equivalence of Hybrid Periodic Orbits}
  \begin{lemma}[Equivalence of Orbits]
    Applying the energy shaping controller to the hybrid control system $\HCS$
    results in the closed-loop hybrid system $\HSeps$ that demonstrates a
    periodic orbit which is identical to the unshaped system $\HS$.
  \end{lemma}
  \begin{block}{Proof}
    The energy of states $\xo \in \orbit$ is a constant,
    $\E(\xo) \equiv \Eref$. By the choice of Lyapunov function,
    $\Ve(\xo) \equiv 0$. In addition, $\dVe(\xo) \equiv 0$ since
    the system is conservative. And since the solution to the optimization
    problem has cost $\uu^{T}(\xo) \uu(\xo) \equiv 0$, the
    control effort is also zero. Hence the orbits are equivalent.
  \end{block}
\end{frame}

\begin{frame}[t]
  \frametitle{Boundedness of \TtI{} function}
  \only<1> {
    The difference in solutions between the shaped and unshaped systems can be
    bounded by examining the difference in solutions:
    \begin{lemma}[Boundedness of \TtI{}]
      For the hybrid systems $\HS$ and $\HSeps$,
      \begin{eqnarray}
        \nonumber
        &| \TIe(\Deltaxz) - \TI(\Deltaxz) | \leq \ATIe \nzdxzst,
      \end{eqnarray}
      where $\limeps \ATIe = 0$.
    \end{lemma}
  }
  \only<2> {
    \begin{block}{Proof (Boundedness of \TtI{})}
      Construct an auxiliary \tti{} function $\TB$ which is locally Lipschitz
      continuous and independent of $\resclfparam$:
      \begin{align*}
        \TB(\eta, \zdx, \zdz) = \inf\{t \geq 0 : h(\eta + \flowt(\Delta(0, \zdzst))) = 0\}.
      \end{align*}
      By construction,
      \begin{align*}
        \TB(0, \zdx, \zdz) = \TI\argsxz.
      \end{align*}
    \end{block}
  }

  \only<3> {
    \begin{block}{Proof (Boundedness of \TtI{})}
      Let $\argsxzti{1}$ and $\argsxzti{2}$ satisfy\vspace{-.4em}
      \begin{align*}
        \argsDxzti{1} = \floweps\argsxzti{1}, && \argsDxzti{2} =
        \flow\argsxzti{2},
      \end{align*}
      with initial conditions $\argsxzizero{1} = \argsxzizero{2} = \Delta(0,
      \zdzst)$. Define
      \begin{align*}
        \etaeps = \left.\argsxzti{1}\right|_{t = \TIe\argsxz} -
        \left.\argsxzti{2}\right|_{t = \TIe\argsxz}
      \end{align*}
      and as a result,\vspace{-.4em}
      \begin{align*}
        \TIe\argsxz = \TB(\etaeps, \zdx, \zdz).
      \end{align*}

    \end{block}
  }
  
  \only<4> {
    \begin{block}{Proof (Boundedness of \TtI{})}
      Because $\TB$ is Lipschitz continuous, it follows that
      \begin{align*}
        | \TIe\argsxz - \TI\argsxz | &= | \TB(\etaeps, \zdx, \zdz) - \TB(0, \zdx, \zdz)|\\
        &\leq \LB \| \etaeps \|
      \end{align*}
      It can be shown that $\| \etaeps \|$ has a bound of the form
      \begin{align*}
        | \TIe(\Deltaxz) - \TI(\Deltaxz) | \leq \ATIe \nzdxzst.
      \end{align*}
       and that $\limeps \ATIe = 0$. \hfill \qedsymbol
    \end{block}
  }
\end{frame}

\begin{frame}[t]
  \frametitle{Boundedness of \Poincare{} Maps}
  \only<1> {
    The difference in \Poincare{} maps of the unshaped and shaped systems can be
    bounded by examining the difference in solutions:
    \begin{lemma}[Boundedness of \Poincare{} Maps]
      For the hybrid systems $\HS$ and $\HSeps$,
      \begin{eqnarray}
        \nonumber
        &\| \Pe\argsxz - \P\argsxz \| \leq \Ae \nzdxzst,
      \end{eqnarray}
      where  $\limeps\Ae = 0$.
    \end{lemma}
  }

  \only<2> {
    \begin{block}{Proof (Boundedness of \Poincare{} Maps)}
      \begin{align*}
        \lefteqn{\left\| \Pe\argsxz - \P\argsxz \right\| \leq}\\
        & \hspace{2em} \int_{\TIDelta}^{\TIeDelta} \hspace{-2.5em} \left\| \bigF\argsxztau \right\| \, d\tau\\
        & \hspace{4em} \mbox{} + \int_{0}^{\TIeDelta} \hspace{-2.5em} \left\| \bigG\argsxztau \, \mueps\argsxztau \, \right\| d\tau.
      \end{align*}
    \end{block}
  }

  \only<3> {
    \begin{block}{Proof (Boundedness of \Poincare{} Maps)}
      Using the explicit solution given by the min-norm controller and the bounds
      established on the difference in \tti{} functions, the bounds can be
      evaluated and the result is a bound of the form
      \begin{align*}
        \left\| \Pe\argsxz - \P\argsxz \right\| \leq \Ae \! \nzdxzst,
      \end{align*}
      where  $\limeps\Ae = 0$. \hfill \qedsymbol
    \end{block}
  }
\end{frame}

\begin{frame}[t]
  \frametitle{Proof of Energy Shaping Theorem}
  \only<1> {
    Define a composite Lyapunov function,
    \begin{align*}
      \VP\argsxz = \Vn\argsxz + \sigma \Vex(\zdx),
    \end{align*}
    where
    \begin{itemize}
    \item $\Vn$ : Lyapunov function guaranteed by stability of the nominal system
      (converse Lyapunov theorem)
    \item $\Vex$ : Lyapunov function for energy shaping control law
    \end{itemize}
    with scaling parameter $\sigma$. This is a discrete Lyapunov function that
    is valid on the guard.
  }
  
  \only<2> {
    Exponential stability of the hybrid system $\HS$ is guaranteed by the
    discrete Lyapunov theorem if
    \begin{eqnarray*}
      &r_{1} \nzdxzst^{2} \leq \VP\argsxz \leq r_{2} \nzdxzst^{2}\\
      &\VP(\Pe\argsxz) - \VP\argsxz \leq r_{3} \nzdxzst^{2}
    \end{eqnarray*}
    for some $r_{1}, r_{2}, r_{3} \in \Rnn$.
  }
\end{frame}
